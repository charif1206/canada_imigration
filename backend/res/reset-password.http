############################
# ðŸ” PASSWORD RESET & EMAIL VERIFICATION TESTS
############################
# Complete testing guide for password reset flow, email verification, and token validation

### ðŸ“Œ CONFIGURATION
@baseUrl = http://localhost:3000
@contentType = application/json

### ðŸ”‘ TOKENS (Update after testing)
# Copy verification token from email or database after running forgot-password request
@resetToken = your_reset_token_here
@verificationToken = your_verification_token_here

# Client email for testing
@clientEmail = abedcharif027@gmail.com

### ðŸ“‹ QUICK START - PASSWORD RESET FLOW
############################
# Follow these steps in order:
# 1. Register a new client (or use existing email)
# 2. Run: Request password reset (forgot-password)
# 3. Check database or email for reset token
# 4. Update @resetToken variable with the token
# 5. Run: Reset password with new password
# 6. Login with new password to verify

### ðŸ”´ IMPORTANT NOTES:
# - Reset tokens expire in 1 HOUR
# - Verification tokens expire in 24 HOURS
# - Tokens are single-use (once used, they expire)
# - Always use your actual email when testing


#########################################
# âœ… STEP 1: REQUEST PASSWORD RESET (CLIENT)
#########################################
### Endpoint: POST /clients/forgot-password
### Access: Public (no authentication required)
### Description: Sends password reset email to client
### Required: email
### Response: Contains reset token (in production, only in email)

# @name clientForgotPassword
POST {{baseUrl}}/clients/auth/forgot-password
Content-Type: {{contentType}}

{
  "email": "{{clientEmail}}"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Password reset email sent successfully. Please check your email.",
#   "resetToken": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6" (in development only)
# }

### âŒ Expected Error Response (404):
# {
#   "statusCode": 404,
#   "message": "Client with email 'invalid@example.com' not found"
# }


###

#########################################
# âœ… STEP 2: REQUEST PASSWORD RESET (ADMIN)
#########################################
### Endpoint: POST /auth/forgot-password
### Access: Public (no authentication required)
### Description: Sends password reset email to admin
### Required: email
### Response: Contains reset token (in production, only in email)

# @name adminForgotPassword
POST {{baseUrl}}/auth/forgot-password
Content-Type: {{contentType}}

{
  "email": "admin@immigration.com"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Password reset email sent successfully. Please check your email.",
#   "resetToken": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6" (in development only)
# }

### âŒ Expected Error Responses:
# 404: Admin with email not found
# 429: Too many requests (rate limited)


###

#########################################
# âœ… STEP 3: RESET PASSWORD (CLIENT)
#########################################
### Endpoint: POST /clients/reset-password
### Access: Public (token in body)
### Description: Validates token and updates password
### Required: token, newPassword, confirmPassword
### Token expiry: 1 HOUR

# @name clientResetPassword
POST {{baseUrl}}/clients/reset-password
Content-Type: {{contentType}}

{
  "token": "{{resetToken}}",
  "newPassword": "NewSecurePass456!",
  "confirmPassword": "NewSecurePass456!"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Password reset successfully. You can now login with your new password."
# }

### âŒ Expected Error Responses:
# 400: Token is invalid or expired
# 400: Passwords do not match
# 400: New password must be at least 8 characters
# 404: Client not found


###

#########################################
# âœ… STEP 4: RESET PASSWORD (ADMIN)
#########################################
### Endpoint: POST /auth/reset-password
### Access: Public (token in body)
### Description: Validates token and updates admin password
### Required: token, newPassword, confirmPassword
### Token expiry: 1 HOUR

# @name adminResetPassword
POST {{baseUrl}}/auth/reset-password
Content-Type: {{contentType}}

{
  "token": "{{resetToken}}",
  "newPassword": "AdminNewPass789!",
  "confirmPassword": "AdminNewPass789!"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Password reset successfully. You can now login with your new password."
# }

### âŒ Expected Error Responses:
# 400: Token is invalid or expired
# 400: Passwords do not match
# 404: Admin not found


###

#########################################
# âœ… STEP 5: VERIFY EMAIL (CLIENT)
#########################################
### Endpoint: POST /clients/verify-email
### Access: Public (token in body)
### Description: Validates email verification token and marks email as verified
### Required: token
### Token expiry: 24 HOURS
### Note: Usually called automatically via email link in frontend

# @name clientVerifyEmail
POST {{baseUrl}}/clients/verify-email
Content-Type: {{contentType}}

{
  "token": "{{verificationToken}}"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Email verified successfully!"
# }

### âŒ Expected Error Responses:
# 400: Token is invalid or expired
# 400: Email is already verified
# 404: Client not found


###

#########################################
# âœ… STEP 6: VERIFY EMAIL (ADMIN)
#########################################
### Endpoint: POST /auth/verify-email
### Access: Public (token in body)
### Description: Validates admin email verification token
### Required: token
### Token expiry: 24 HOURS

# @name adminVerifyEmail
POST {{baseUrl}}/auth/verify-email
Content-Type: {{contentType}}

{
  "token": "{{verificationToken}}"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Email verified successfully!"
# }

### âŒ Expected Error Responses:
# 400: Token is invalid or expired
# 400: Email is already verified
# 404: Admin not found


###

#########################################
# âœ… STEP 7: RESEND VERIFICATION EMAIL (CLIENT)
#########################################
### Endpoint: POST /clients/resend-verification
### Access: Public (no authentication required)
### Description: Generates new verification token and resends email
### Required: email
### Use case: Client didn't receive initial verification email

# @name clientResendVerification
POST {{baseUrl}}/clients/resend-verification
Content-Type: {{contentType}}

{
  "email": "{{clientEmail}}"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Verification email sent successfully. Please check your email.",
#   "verificationToken": "x1y2z3a4b5c6d7e8f9g0h1i2j3k4l5m6" (in development only)
# }

### âŒ Expected Error Responses:
# 404: Client with email not found
# 400: Email is already verified


###

#########################################
# âœ… STEP 8: RESEND VERIFICATION EMAIL (ADMIN)
#########################################
### Endpoint: POST /auth/resend-verification
### Access: Public (no authentication required)
### Description: Generates new verification token and resends email to admin
### Required: email
### Use case: Admin didn't receive initial verification email

# @name adminResendVerification
POST {{baseUrl}}/auth/resend-verification
Content-Type: {{contentType}}

{
  "email": "admin@immigration.com"
}

### âœ… Expected Success Response (200):
# {
#   "success": true,
#   "message": "Verification email sent successfully. Please check your email.",
#   "verificationToken": "x1y2z3a4b5c6d7e8f9g0h1i2j3k4l5m6" (in development only)
# }

### âŒ Expected Error Responses:
# 404: Admin with email not found
# 400: Email is already verified


###

#########################################
# ðŸ§ª FULL TEST SCENARIO: COMPLETE FLOW
#########################################
### This scenario tests the entire password reset journey

### 1. Register a new client
POST {{baseUrl}}/clients/register
Content-Type: {{contentType}}

{
  "name": "Password Test User",
  "email": "password-test-{{$timestamp}}@example.com",
  "password": "InitialPass123!",
  "phone": "+1234567890"
}

### 2. Wait a moment, then request password reset
### (Copy the email from registration response and update @clientEmail)
###

### 3. Request password reset
POST {{baseUrl}}/clients/forgot-password
Content-Type: {{contentType}}

{
  "email": "password-test-1730000000@example.com"
}

### 4. Copy resetToken from response and update @resetToken
###

### 5. Reset password with new password
POST {{baseUrl}}/clients/reset-password
Content-Type: {{contentType}}

{
  "token": "{{resetToken}}",
  "newPassword": "UpdatedPass456!",
  "confirmPassword": "UpdatedPass456!"
}

### 6. Login with new password to verify
POST {{baseUrl}}/clients/login
Content-Type: {{contentType}}

{
  "email": "password-test-1730000000@example.com",
  "password": "UpdatedPass456!"
}

### âœ… If you get access_token, password reset worked!


###

#########################################
# ðŸ”’ SECURITY & VALIDATION TESTS
#########################################

### âŒ TEST: Invalid token format
POST {{baseUrl}}/clients/reset-password
Content-Type: {{contentType}}

{
  "token": "invalid-token-123",
  "newPassword": "NewPass123!",
  "confirmPassword": "NewPass123!"
}

### Expected: 400 - Invalid token


###

### âŒ TEST: Passwords don't match
POST {{baseUrl}}/clients/reset-password
Content-Type: {{contentType}}

{
  "token": "{{resetToken}}",
  "newPassword": "NewPass123!",
  "confirmPassword": "DifferentPass456!"
}

### Expected: 400 - Passwords do not match


###

### âŒ TEST: Password too short
POST {{baseUrl}}/clients/reset-password
Content-Type: {{contentType}}

{
  "token": "{{resetToken}}",
  "newPassword": "Short1!",
  "confirmPassword": "Short1!"
}

### Expected: 400 - Password must be at least 8 characters


###

### âŒ TEST: Empty password
POST {{baseUrl}}/clients/reset-password
Content-Type: {{contentType}}

{
  "token": "{{resetToken}}",
  "newPassword": "",
  "confirmPassword": ""
}

### Expected: 400 - Password is required


###

### âŒ TEST: Non-existent email
POST {{baseUrl}}/clients/forgot-password
Content-Type: {{contentType}}

{
  "email": "nonexistent-user@example.com"
}

### Expected: 404 - Client not found


###

#########################################
# ðŸ“§ EMAIL VERIFICATION FLOW
#########################################

### Register and get verification token
POST {{baseUrl}}/clients/register
Content-Type: {{contentType}}

{
  "name": "Email Verification Test",
  "email": "verify-test-{{$timestamp}}@example.com",
  "password": "VerifyPass123!",
  "phone": "+1234567890"
}

### Response will include verificationToken in development


###

### Verify email with token
POST {{baseUrl}}/clients/verify-email
Content-Type: {{contentType}}

{
  "token": "{{verificationToken}}"
}

### Expected: 200 - Email verified successfully


###

### Try verifying again (should fail - already verified)
POST {{baseUrl}}/clients/verify-email
Content-Type: {{contentType}}

{
  "token": "{{verificationToken}}"
}

### Expected: 400 - Email is already verified


###

### Resend verification email
POST {{baseUrl}}/clients/resend-verification
Content-Type: {{contentType}}

{
  "email": "verify-test-1730000000@example.com"
}

### Expected: 200 - New verification email sent


###

#########################################
# ðŸ“Š DATABASE QUERY REFERENCE
#########################################

### View all clients with their verification status:
### SELECT id, email, "isEmailVerified", "emailVerificationExpires", "resetPasswordExpires" FROM "Client";

### View specific client:
### SELECT * FROM "Client" WHERE email = 'test@example.com';

### Check if reset token is still valid:
### SELECT * FROM "Client" WHERE "resetPasswordToken" = 'your_token_here' AND "resetPasswordExpires" > NOW();

### Clear expired tokens (manual cleanup):
### UPDATE "Client" SET "resetPasswordToken" = NULL WHERE "resetPasswordExpires" < NOW();

