### ========================================
### üçÅ CANADA IMMIGRATION - AUTH MODULE TESTS
### ========================================
### Based on: auth.controller.ts & auth.service.ts
### Endpoints: POST /login, POST /register, GET /profile, PATCH /change-password
### ========================================

### üìå CONFIGURATION
@baseUrl = http://localhost:3000
@contentType = application/json

### üîë STEP 1: Login first to get your token
### After running the login request below, copy the access_token 
### from the response and paste it in the @token variable
@token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlmIiwic3ViIjoiOWJjZWZmYzMtM2ZlOC00ZTZmLTljNDgtNTVlZGJiNGM4OGNlIiwicm9sZSI6ImFkbWluIiwiaWF0IjoxNzYyNDY1MTI5LCJleHAiOjE3NjI1NTE1Mjl9.HViGpmKiBUYbBYIR8jHmTlLRbUwFrZZOUrh8fuXoC8Y


### ========================================
### ‚úÖ TEST 1: LOGIN - Default Admin Credentials
### ========================================
### Endpoint: POST /auth/login
### Access: Public (no authentication required)
### Default credentials created on server startup
# @name login
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "username": "chrif",
  "password": "chrif1206"
}

### ‚úÖ Expected Success Response (200):
# {
#   "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "admin": {
#     "id": "uuid-here",
#     "username": "admin",
#     "email": "admin@immigration.com",
#     "role": "admin"
#   }
# }

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Admin account with username 'admin' does not exist..."
# }
# OR
# {
#   "statusCode": 401,
#   "message": "Password is incorrect. Please check your password and try again."
# }


###
### ========================================
### ‚úÖ TEST 2: GET PROFILE - Authenticated Route
### ========================================
### Endpoint: GET /auth/profile
### Access: Protected (requires Bearer token)
### Returns: Current admin's profile information
GET {{baseUrl}}/auth/profile
Authorization: Bearer {{token}}

### ‚úÖ Expected Success Response (200):
# {
#   "id": "uuid-here",
#   "username": "admin",
#   "email": "admin@immigration.com",
#   "role": "admin",
#   "createdAt": "2024-11-06T...",
#   "updatedAt": "2024-11-06T..."
# }

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Unauthorized"
# }


###
### ========================================
### ‚úÖ TEST 3: REGISTER NEW ADMIN - Protected Route
### ========================================
### Endpoint: POST /auth/register
### Access: Protected (requires Bearer token + admin role)
### Description: Only authenticated admins can create new admins
POST {{baseUrl}}/auth/register
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "username": "newadmin",
  "email": "newadmin@example.com",
  "password": "SecurePass123!",
  "role": "admin"
}

### ‚úÖ Expected Success Response (200):
# {
#   "id": "new-uuid",
#   "username": "newadmin",
#   "email": "newadmin@example.com",
#   "role": "admin",
#   "createdAt": "2024-11-06T...",
#   "updatedAt": "2024-11-06T..."
# }
# Note: Password is NOT returned in response

### ‚ùå Expected Error Responses:
# 401 Unauthorized (if not authenticated)
# 401 if username already exists:
# {
#   "message": "Username 'newadmin' is already taken. Please choose a different username."
# }
# 401 if email already exists:
# {
#   "message": "Email 'newadmin@example.com' is already registered..."
# }


###
### ========================================
### ‚úÖ TEST 4: CHANGE PASSWORD - Protected Route
### ========================================
### Endpoint: PATCH /auth/change-password
### Access: Protected (requires Bearer token)
### Description: Change password for currently authenticated admin
### ‚ö†Ô∏è WARNING: After changing password, you'll need to login again!
PATCH {{baseUrl}}/auth/change-password
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "oldPassword": "admin123",
  "newPassword": "NewSecurePass123!"
}

### ‚úÖ Expected Success Response (200):
# {
#   "message": "Password changed successfully"
# }

### ‚ùå Expected Error Responses:
# 401 if old password is wrong:
# {
#   "message": "Current password is incorrect. Please enter your correct current password..."
# }
# 401 if admin not found:
# {
#   "message": "Admin account not found. Your session may have expired. Please log in again."
# }


###
### ========================================
### ‚ùå TEST 5: LOGIN - Wrong Password
### ========================================
### Should return 401 with clear error message
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "username": "admin",
  "password": "wrongpassword123"
}

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Password is incorrect. Please check your password and try again."
# }


###
### ========================================
### ‚ùå TEST 6: LOGIN - Non-existent Username
### ========================================
### Should return 401 with clear error message
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "username": "nonexistentuser",
  "password": "anypassword"
}

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Admin account with username 'nonexistentuser' does not exist..."
# }


###
### ========================================
### ‚ùå TEST 7: ACCESS PROFILE WITHOUT TOKEN
### ========================================
### Should return 401 Unauthorized
GET {{baseUrl}}/auth/profile

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Unauthorized"
# }


###
### ========================================
### ‚ùå TEST 8: ACCESS PROFILE WITH INVALID TOKEN
### ========================================
### Should return 401 Unauthorized
GET {{baseUrl}}/auth/profile
Authorization: Bearer invalid_token_12345

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Unauthorized"
# }


###
### ========================================
### ‚ùå TEST 9: REGISTER WITHOUT AUTHENTICATION
### ========================================
### Should return 401 Unauthorized
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "unauthorized",
  "email": "unauthorized@example.com",
  "password": "Test123!",
  "role": "admin"
}

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Unauthorized"
# }


###
### ========================================
### ‚ùå TEST 10: REGISTER DUPLICATE USERNAME
### ========================================
### Should return error message
POST {{baseUrl}}/auth/register
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "username": "admin",
  "email": "different@example.com",
  "password": "SecurePass123!",
  "role": "admin"
}

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Username 'admin' is already taken. Please choose a different username."
# }


###
### ========================================
### ‚ùå TEST 11: REGISTER DUPLICATE EMAIL
### ========================================
### Should return error message
POST {{baseUrl}}/auth/register
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "username": "differentuser",
  "email": "admin@immigration.com",
  "password": "SecurePass123!",
  "role": "admin"
}

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Email 'admin@immigration.com' is already registered..."
# }


###
### ========================================
### ‚ùå TEST 12: CHANGE PASSWORD - Wrong Old Password
### ========================================
### Should return error message
PATCH {{baseUrl}}/auth/change-password
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "oldPassword": "wrongoldpassword",
  "newPassword": "NewPassword123!"
}

### ‚ùå Expected Error Response (401):
# {
#   "statusCode": 401,
#   "message": "Current password is incorrect. Please enter your correct current password..."
# }


###
### ========================================
### üîÑ CLEANUP: RESET PASSWORD TO DEFAULT
### ========================================
### Run this if you changed the password and want to restore it
### Uncomment the request below and update oldPassword if needed
# PATCH {{baseUrl}}/auth/change-password
# Authorization: Bearer {{token}}
# Content-Type: {{contentType}}
# 
# {
#   "oldPassword": "NewSecurePass123!",
#   "newPassword": "admin123"
# }


###
### ========================================
### üìã TESTING CHECKLIST
### ========================================
### ‚úÖ Test 1: Login with default credentials ‚Üí Returns access_token
### ‚úÖ Test 2: Get profile ‚Üí Returns admin data
### ‚úÖ Test 3: Register new admin ‚Üí Creates admin successfully
### ‚úÖ Test 4: Change password ‚Üí Success message
### ‚ùå Test 5: Wrong password ‚Üí 401 with clear message
### ‚ùå Test 6: Non-existent user ‚Üí 401 with clear message
### ‚ùå Test 7-9: No/Invalid token ‚Üí 401 Unauthorized
### ‚ùå Test 10-11: Duplicate username/email ‚Üí Error messages
### ‚ùå Test 12: Wrong old password ‚Üí Error message


###
### ========================================
### üéØ AVAILABLE ROLES
### ========================================
### - admin (default)
### - super-admin
### - moderator


###
### ========================================
### üìù NOTES
### ========================================
### 1. Default admin is created automatically on server startup
### 2. Username: admin, Password: admin123
### 3. Change default password immediately in production!
### 4. All error messages are user-friendly and descriptive
### 5. Passwords are hashed with bcrypt (10 rounds)
### 6. JWT tokens are signed with secret from .env
### 7. Register endpoint requires admin authentication
### 8. Password field is never returned in responses


###
### ========================================
### üîê SECURITY FEATURES
### ========================================
### ‚úÖ Bcrypt password hashing
### ‚úÖ JWT authentication
### ‚úÖ Role-based access control (RBAC)
### ‚úÖ Password never returned in responses
### ‚úÖ Clear, user-friendly error messages
### ‚úÖ Protected registration endpoint
### ‚úÖ Token-based authorization
