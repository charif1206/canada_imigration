### ========================================
### Messages Module Tests
### Canada Immigration Application
### ========================================

### Variables
@baseUrl = http://localhost:3000
@contentType = application/json

# First, create a client to get clientId
# @name createTestClient
POST {{baseUrl}}/clients
Content-Type: {{contentType}}

{
  "name": "Message Test Client",
  "email": "messagetest@example.com",
  "phone": "+1-416-555-9000"
}

### Get clientId from response
@clientId = {{createTestClient.response.body.id}}

### ========================================
### Test 1: Client Sends Message to Admin
### ========================================
# @name sendMessage1
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Question about my application",
  "content": "Hello, I submitted my application last week. When can I expect a response? Thank you."
}

### Expected: 201 Created with message data
### Side effects:
### - WhatsApp notification sent to admin (if configured)
### - Real-time notification to admin dashboard via WebSocket
### - Message saved with isRead = false

### ========================================
### Test 2: Send Another Message
### ========================================
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Additional documents",
  "content": "I have my updated passport. How can I submit it to you?"
}

### Expected: 201 Created

### ========================================
### Test 3: Get Messages for Specific Client
### ========================================
GET {{baseUrl}}/clients/{{clientId}}/messages

### Expected: Array of messages for this client

### ========================================
### Test 4: Get All Unread Messages (Admin)
### This endpoint should be protected with JWT
### ========================================
GET {{baseUrl}}/admin/messages

### Expected: Array of all unread messages with client info

### ========================================
### Test 5: Mark Message as Read
### Replace {messageId} with actual ID from Test 1
### ========================================
@messageId = {{sendMessage1.response.body.id}}
PATCH {{baseUrl}}/clients/messages/{{messageId}}/read

### Expected: Message updated with isRead = true

### ========================================
### Test 6: Send Message with Non-existent Client ID
### Should fail
### ========================================
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "invalid-client-id-12345",
  "subject": "Test",
  "content": "This should fail"
}

### Expected: Error - Client not found

### ========================================
### Test 7: Send Message with Missing Fields
### Should fail validation
### ========================================
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Missing content"
}

### Expected: 400 Bad Request - Validation error

### ========================================
### Test 8: Send Empty Message
### Should fail validation
### ========================================
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "",
  "content": ""
}

### Expected: 400 Bad Request - Fields cannot be empty

### ========================================
### Test 9: Send Message with Long Content
### Test handling of large text
### ========================================
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Detailed inquiry about documentation requirements",
  "content": "Dear Immigration Officer, I am writing to inquire about the specific documentation requirements for my skilled worker application. I have several questions: 1) Do I need to provide original documents or are certified copies acceptable? 2) Should my work experience letters be notarized? 3) What is the process for document translation if some of my certificates are in another language? 4) Is there a specific format required for reference letters? 5) How recent should my police clearance certificate be? I want to ensure I submit everything correctly the first time to avoid delays. Thank you for your assistance."
}

### Expected: 201 Created

### ========================================
### Test 10: Send Multiple Messages Rapidly
### Test system under load
### ========================================
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Rapid Test 1",
  "content": "Testing rapid message submission - Message 1"
}

###

POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Rapid Test 2",
  "content": "Testing rapid message submission - Message 2"
}

###

POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Rapid Test 3",
  "content": "Testing rapid message submission - Message 3"
}

### ========================================
### Test 11: Send Message with Special Characters
### ========================================
POST {{baseUrl}}/clients/messages
Content-Type: {{contentType}}

{
  "clientId": "{{clientId}}",
  "subject": "Sp√©cial √áharacters & √âmojis üçÅ",
  "content": "Testing special characters: Fran√ßois, M√ºller, Jos√©, ≈Åukasz. Also testing: ¬© ‚Ñ¢ ‚Ç¨ ¬£ ¬• ‚Ä¢ ‚Ä¶"
}

### Expected: 201 Created with proper character encoding

### ========================================
### Success Criteria:
### ‚úÖ Test 1-2: Messages created successfully
### ‚úÖ Test 3: Returns messages for client
### ‚úÖ Test 4: Returns all unread messages
### ‚úÖ Test 5: Message marked as read
### ‚úÖ Tests 6-8: Return validation errors
### ‚úÖ Test 9: Long content handled properly
### ‚úÖ Test 10: Rapid messages accepted
### ‚úÖ Test 11: Special characters preserved
### 
### Check Backend Logs For:
### - "Creating message from client: ..."
### - "New message from {client name}"
### - WhatsApp notification attempts
### 
### Check Admin Dashboard For:
### - Real-time notification popups
### - Unread message count increase
### - Messages appear in list
### ========================================
