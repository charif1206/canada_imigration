generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                                String    @id @default(uuid())
  name                              String
  email                             String    @unique
  password                          String    @default("$2b$10$defaultpasswordhash")
  passportNumber                    String?
  nationality                       String?
  isValidated                       Boolean   @default(false)
  validatedAt                       DateTime?
  validatedBy                       String?
  // Email verification fields
  isEmailVerified                   Boolean   @default(false)
  emailVerificationToken            String?   @unique
  emailVerificationExpires          DateTime?
  // Password reset fields
  resetPasswordToken                String?   @unique
  resetPasswordExpires              DateTime?
  // Form submission tracking
  isSendingFormulaireEquivalence    Boolean   @default(false)
  equivalenceStatus                 String?   // "pending", "validated", "rejected"
  equivalenceRejectedAt             DateTime?
  equivalenceRejectionReason        String?
  isSendingFormulaireResidence      Boolean   @default(false)
  residenceStatus                   String?   // "pending", "validated", "rejected"
  residenceRejectedAt               DateTime?
  residenceRejectionReason          String?
  isSendingPartners                 Boolean   @default(false)
  partnerStatus                     String?   // "pending", "validated", "rejected"
  partnerRejectedAt                 DateTime?
  partnerRejectionReason            String?
  createdAt                         DateTime  @default(now())
  updatedAt                         DateTime  @updatedAt
  messages                          Message[]
  formSubmissions                   FormSubmission[]
}

model Admin {
  id                        String   @id @default(uuid())
  username                  String   @unique
  password                  String
  email                     String?
  role                      String   @default("admin")
  // Email verification fields
  isEmailVerified           Boolean  @default(false)
  emailVerificationToken    String?  @unique
  emailVerificationExpires  DateTime?
  // Password reset fields
  resetPasswordToken        String?  @unique
  resetPasswordExpires      DateTime?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model Message {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  subject   String
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([clientId])
}

// Forms submitted by clients (equivalence / residence / others).
// Uses Json column for flexible data storage, but maintains referential integrity with Client.
// When a client is deleted, all their form submissions are automatically deleted (cascade).
model FormSubmission {
  id        String   @id @default(uuid())
  clientId  String   // Foreign key to Client
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  type      String   // "EQUIVALENCE" or "RESIDENCE"
  data      Json     // Stores all form fields (flexible structure)
  fileUrl   String?  // URL to uploaded file (portfolio, supporting docs, etc)
  createdAt DateTime @default(now())
  
  @@index([clientId])  // Index for fast queries: "find all forms for client X"
}

// Partner applications from travel agencies
model PartnerSubmission {
  id        String   @id @default(uuid())
  type      String   @default("PARTNER")
  data      Json     // Stores all partner application fields (agencyName, managerName, email, phone, etc)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
